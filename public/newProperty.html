<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Registrar Inmueble</title>
	<link rel="stylesheet" href="./css/styles.css" />
</head>

<body>

	<div class="content">

		<form id="formNewProperty">

			<div class="flexbox column center-v spaced-inner-top spaced-inner-bottom overflow">

				<div class="flexbox row center-h spaced-top">
					<div class="label title-x2">Nuevo inmueble</div>

					<div class="sep x2"></div>
					<div class="sep x2"></div>

					<a class="button" href="./index.html">Cancelar</a>
					<div class="sep"></div>
					<button class="button black" name="submit" type="submit">
						Registrar inmueble
					</button>
				</div>

				<div class="flexbox row center-h">

					<div class="flexbox column spaced-top">

						<div class="flexbox column block round form">

								<div class="label title">Tipo de inmueble</div>
								<select name="propertyType" class="select">
									<option value="1">Vivienda</option>
									<option value="2">Garaje</option>
									<option value="3">Obra Nueva</option>
								</select>

								<div class="label title">Método de venta</div>
								<select name="propertyMethod" class="select">
									<option value="1">Vender</option>
									<option value="2">Alquilar</option>
								</select>
			
								<div class="label title">Catastro</div>
								<input class="mode-fill" type="text" name="catast" id="catast" placeholder="0000000AA0000A0000AA" required/>

								<div class="label title">Dirección</div>
								<textarea class="mode-fill no-resize" name="place" id="place" placeholder="AV PRIMADO REIG 151 Es:1 Pl:02 Pt:04" required></textarea>

								<div class="label title">Superficie</div>
								<input class="mode-fill" type="text" name="location" id="location" placeholder="98 m²" value=""
								required/>

								<div class="label title">Precio</div>
								<input class="mode-fill" type="text" name="location" id="location" placeholder="100.000 €" value=""
								required/>

						</div>

						<div class="filters flexbox column block round form spaced-top">

							<div class="propertyType-home">

								<div class="label title">Tipo de vivienda</div>
								<select name="homeType" class="select">
									<option value="1">Piso</option>
									<option value="2">Ático</option>
									<option value="3">Bajo</option>
									<option value="4">Dúplex</option>
								</select>

								<div class="label title">Habitaciones</div>
								<select name="roomCount" class="select">
									<option value="1">0 (estudio)</option>
									<option value="2">1</option>
									<option value="3">2</option>
									<option value="4">3</option>
									<option value="5">4 o más</option>
								</select>

								<div class="label title">Baños</div>
								<select name="bathroomCount" class="select">
									<option value="1">0</option>
									<option value="2">1</option>
									<option value="3">2</option>
									<option value="4">3 o más</option>
								</select>

								<div class="label title optional">Características</div>
								<label><input name="feature featureElevator" type="checkbox" value="1" />
									<div class="label bold">Ascensor</div>
								</label>
								<label><input name="feature featureFurniture" type="checkbox" value="2" />
									<div class="label bold">Amueblado</div>
								</label>
								<label><input name="feature featureBalcony" type="checkbox" value="3" />
									<div class="label bold">Terraza o balcón</div>
								</label>
								<label><input name="feature featureAirConditioning" type="checkbox" value="4" />
									<div class="label bold">Aire acondicionado</div>
								</label>
								<label><input name="feature featureBuiltInCloset" type="checkbox" value="5" />
									<div class="label bold">Armario empotrado</div>
								</label>
								<label><input name="feature featureGarage" type="checkbox" value="6" />
									<div class="label bold">Garaje</div>
								</label>
								<label><input name="feature featureGarden" type="checkbox" value="7" />
									<div class="label bold">Jardín</div>
								</label>
								<label><input name="feature featurePool" type="checkbox" value="8" />
									<div class="label bold">Piscina</div>
								</label>
								<label><input name="feature featureStorageRoom" type="checkbox" value="9" />
									<div class="label bold">Trastero</div>
								</label>

							</div>

						</div>

					</div>

					<div class="filters flexbox column spaced-top spaced" style="margin-right:0;">

						<div class="filters flexbox column block round form">
							
							<div class="label title">Imágenes <div class="label detail" style="margin-left: 6px;"><span id="totalImagesUploaded">0</span> imágenes</div></div>

							<div id="dropArea" class="dropArea">
								<input type="file" class="fileElement" id="fileElement" multiple accept="image/*" onchange="handleFiles(this.files)">
								<label for="fileElement">
									<p>Drop images or click to upload</p>
									<div class="button" style="display:inline-block;">Select some files</div>
								</label>
							</div>
							<div id="gallery" class="gallery">
								<div class="imageOptions hide" id="imageOptions"></div>
							</div>
							
						</div>

					</div>

				</div>

			</div>

		</form>

	</div>

</body>

<script type="text/javascript">

var totalImages = 0,
		totalImagesDIV = document.getElementById("totalImagesUploaded");

	// Get DataURL from image
	function getDataUrl(img) {
		// Create canvas
		const canvas = document.createElement('canvas');
		const ctx = canvas.getContext('2d');
		// Set width and height
		canvas.width = img.width;
		canvas.height = img.height;
		// Draw the image
		ctx.drawImage(img, 0, 0, img.width, img.height);
		return canvas.toDataURL('image/jpeg');
	}

	// Test
	/*
	window.onload = function () {
		const dataUrl = getDataUrl(document.querySelector('#uploadImg'));
		window.open(dataUrl,'_blank');
	};
	*/

	let dropArea = document.querySelector("#dropArea");

	// Prevent default drag behaviors
	["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
		dropArea.addEventListener(eventName, preventDefaults, false)
		document.body.addEventListener(eventName, preventDefaults, false)
	});

	// Highlight drop area when item is dragged over it
	// When enter or hover
	["dragenter", "dragover"].forEach(eventName => {
		dropArea.addEventListener(eventName, highlight, false);
	});
	// When leave or drop
	["dragleave", "drop"].forEach(eventName => {
		dropArea.addEventListener(eventName, unhighlight, false);
	});

	// Handle dropped files
	dropArea.addEventListener("drop", handleDrop, false);

	function preventDefaults (e) {
		e.preventDefault();
		e.stopPropagation();
	}

	function highlight(e) {
		dropArea.classList.add("highlight");
	}

	function unhighlight(e) {
		dropArea.classList.remove("highlight");
	}

	function handleDrop(e) {
		var dt = e.dataTransfer;
		var files = dt.files;

		handleFiles(files);
	}

	function handleFiles(files) {
		files = [...files];
		files.forEach( file => {
			if (file.type.match("image.*") && !file.type.match("image/svg")) {
				previewFile(file);
				totalImagesDIV.textContent = ++totalImages;
			} else {
				console.warn("The file you are trying to upload is not a image! (file is: %s)", file.type.split("/")[1]);
			}
		})
	}

	function previewFile(file) {
		let reader = new FileReader();
		reader.readAsDataURL(file);
		reader.onloadend = function() {
			let img = document.createElement("img");
			img.src = reader.result;
			img.id = convertToCharCode(Date.now());
			img.style.cssText = "width:calc(180px);margin:5px;border-radius:6px;cursor:pointer;";
			document.querySelector("#gallery").appendChild(img);
			//getDataUrl(img);
		}
	}

	function convertToCharCode(num) {
    return num
        .toString()    // convert number to string
        .split('')     // convert string to array of characters
        .map(Number)   // parse characters as numbers
        .map(n => (n || 10) + 64)   // convert to char code, correcting for J
        .map(c => String.fromCharCode(c))   // convert char codes to strings
        .join('');     // join values together
}

	var gallery = document.querySelector("#gallery"),
			imageOptions = document.querySelector("#imageOptions");
	gallery.addEventListener("mousemove", detectImage);
	gallery.addEventListener("click", removeImage);
	gallery.addEventListener("mouseleave", hideImageOptions);

	var tmpTarget;
	function detectImage(e) {
		if (e.target.id != tmpTarget) {
			if (e.target.tagName == "IMG") {
				showImageOptions(e.target.id)
			} else hideImageOptions();
		}
		tmpTarget = e.target.id;
	}

	function showImageOptions(id) {
		var pos = document.getElementById(id).getBoundingClientRect();
		imageOptions.style.top = pos.top - gallery.getBoundingClientRect().top + "px";
		imageOptions.style.left = pos.left - gallery.getBoundingClientRect().left + "px";
		imageOptions.style.width = pos.width + "px";
		imageOptions.style.height = pos.height + "px";
		imageOptions.classList.remove("hide");
	}

	function removeImage(e) {
		if (e.target.tagName == "IMG") {
			e.target.remove();
			totalImagesDIV.textContent = --totalImages;
			hideImageOptions();
		}
	}

	function hideImageOptions() {
		tmpTarget = "";
		imageOptions.classList.add("hide");
	}

</script>

</html>